/**
 * jr-crop - A simple ionic plugin to crop your images.
 * @version 1.1.2
 * @link https://github.com/JrSchild/jr-crop
 * @author Joram Ruitenschild
 * @license MIT
 */

angular.module("jrCrop",["ionic"]).factory("$jrCrop",["$ionicModal","$rootScope","$q",function(t,i,e){var s='<div class="jr-crop modal"><div class="bar bar-header bar-dark jr-crop-footer"><div class="title">{{title}}</div></div><div class="jr-crop-center-container" style="opacity:0.5; background:#000;"><div class="jr-crop-img" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><div class="jr-crop-center-container"><div class="jr-crop-select" ng-class="{\'jr-crop-select-circle\': circle}" style="overflow: hidden" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><div class="bar bar-footer bar-clear jr-crop-footer"><button class="button button-clear" ng-click="cancel()">{{cancelText}}</button><div class="title"><button class="button button-clear" style="margin-top:5px" ng-click="rotateAntiClockwise()">rotate left</button><button class="button button-clear" style="margin-top:5px" ng-click="rotateClockwise()">rotate right</button></div><button class="button button-clear" ng-click="crop()">{{chooseText}}</button></div></div>',o=ionic.views.View.inherit({promise:null,imgWidth:null,imgHeight:null,imgSelect:null,imgFull:null,posX:0,posY:0,scale:1,rotate:0,last_scale:1,last_posX:0,last_posY:0,initialize:function(t){var i=this;i.options=t,i.promise=e.defer(),i.loadImage().then(function(t){i.imgWidth=t.naturalWidth,i.imgHeight=t.naturalHeight,i.options.modal.el.querySelector(".jr-crop-img").appendChild(i.imgSelect=t.cloneNode()),i.options.modal.el.querySelector(".jr-crop-select").appendChild(i.imgFull=t.cloneNode()),i.bindHandlers(),i.initImage()}),i.options.cancel=this.cancel.bind(this),i.options.crop=this.crop.bind(this),i.options.rotateClockwise=this.rotateClockwise.bind(this),i.options.rotateAntiClockwise=this.rotateAntiClockwise.bind(this)},initImage:function(){var t=this.rotate%2===0?this.imgHeight:this.imgWidth,i=this.rotate%2===0?this.imgWidth:this.imgHeight;if(this.options.height<t||this.options.width<i){var e=i/t,s=this.options.width/this.options.height;s>e?this.scale=this.last_scale=this.options.width/i:this.scale=this.last_scale=this.options.height/t}var o=(this.imgWidth-this.options.width)/2,a=(this.imgHeight-this.options.height)/2;this.posX=this.last_posX=-o,this.posY=this.last_posY=-a,this.setImageTransform()},cancel:function(){var t=this;t.options.modal.remove().then(function(){t.promise.reject("canceled")})},bindHandlers:function(){function t(){s(),o.scale<g&&(o.scale=g),o.scale>d&&(o.scale=d)}function i(){e(),o.posX>a&&(o.posX=a),o.posX<r&&(o.posX=r),o.posY>n&&(o.posY=n),o.posY<h&&(o.posY=h)}function e(){var t=o.scale*(o.rotate%2===0?o.imgWidth:o.imgHeight),i=o.scale*(o.rotate%2===0?o.imgHeight:o.imgWidth);a=(t-o.imgWidth)/2,n=(i-o.imgHeight)/2,r=-(t-a-o.options.width),h=-(i-n-o.options.height)}function s(){var t=o.rotate%2===0?o.imgWidth:o.imgHeight,i=o.rotate%2===0?o.imgHeight:o.imgWidth,e=t/i,s=o.options.width/o.options.height;g=e>s?o.options.height/i:o.options.width/t,d=1}var o=this,a=0,n=0,r=0,h=0,c=0,l=0,d=1,g=0,p={prevent_default_directions:["left","right","up","down"]};ionic.onGesture("touch transform drag dragstart dragend",function(e){switch(e.type){case"touch":o.last_scale=o.scale;break;case"drag":o.posX=o.last_posX+e.gesture.deltaX-c,o.posY=o.last_posY+e.gesture.deltaY-l,i();break;case"transform":o.scale=o.last_scale*e.gesture.scale,t();break;case"dragend":o.last_posX=o.posX,o.last_posY=o.posY;break;case"dragstart":o.last_scale=o.scale,e.gesture.deltaX>1||e.gesture.deltaX<-1?(c=e.gesture.deltaX,l=e.gesture.deltaY):(c=0,l=0)}o.setImageTransform()},o.options.modal.el,p)},setImageTransform:function(){var t=this,i="translate3d("+t.posX+"px,"+t.posY+"px, 0) scale3d("+t.scale+","+t.scale+", 1) rotateZ("+90*t.rotate+"deg)";t.imgSelect.style[ionic.CSS.TRANSFORM]=i,t.imgFull.style[ionic.CSS.TRANSFORM]=i},rotateClockwise:function(){this.rotate=(this.rotate+1)%4,this.initImage()},rotateAntiClockwise:function(){this.rotate=(this.rotate+3)%4,this.initImage()},crop:function(){var t=document.createElement("canvas"),i=t.getContext("2d");t.width=this.options.width/this.scale,t.height=this.options.height/this.scale;var e=(this.rotate%2===0?this.imgWidth:this.imgHeight)*this.scale,s=(this.rotate%2===0?this.imgHeight:this.imgWidth)*this.scale,o=(e-this.imgWidth)/2,a=(s-this.imgHeight)/2,n=(this.posX-o)/this.scale,r=(this.posY-a)/this.scale,h=n,c=r;1===this.rotate?(h=r,c=-n-this.imgHeight):2===this.rotate?(h=-n-this.imgWidth,c=-r-this.imgHeight):3===this.rotate&&(h=-r-this.imgWidth,c=n),i.rotate(Math.PI/2*this.rotate),i.drawImage(this.imgFull,h,c),this.options.modal.remove(),this.promise.resolve(t)},loadImage:function(){var t=e.defer();return angular.element("<img />").bind("load",function(i){t.resolve(this)}).bind("error",t.reject).prop("src",this.options.url),t.promise}});return{defaultOptions:{width:0,height:0,aspectRatio:0,cancelText:"Cancel",chooseText:"Choose",template:s,circle:!1},crop:function(e){e=this.initOptions(e);var s=i.$new(!0);return ionic.extend(s,e),s.modal=t.fromTemplate(e.template,{scope:s}),s.modal.show().then(function(){return new o(s).promise.promise})},initOptions:function(t){var i;return i=ionic.extend({},this.defaultOptions),i=ionic.extend(i,t),i.aspectRatio&&(!i.width&&i.height&&(i.width=200),i.width?i.height=i.width/i.aspectRatio:i.height&&(i.width=i.height*i.aspectRatio)),i}}}]);
